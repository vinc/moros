#! lisp

(load "/lib/lisp/core.lsp")

(var config "/ini/pkg")
(var base (if (file/exists? config) (str/trim (read config)) "10.0.2.2:8181"))

(def (fetch path) (do
  (print (str "Fetching '" path "'"))
  (var dir (dirname path))
  (if (not (file/exists? dir))
    (sh (str "write -p " dir "/")))
  (sh (str "http " base path " => " path))))

(var cmd (first args))

(if (or (eq? cmd "install") (eq? cmd "i"))
  (do
    (var pkg (second args))
    (var path (str "/var/pkg/" pkg))
    (if (= (fetch path) 0)
      (do
        (var files (reverse (lines (read path))))
        (map fetch files))
      (do
        (error (str "Could not find package '" pkg "'"))
        (sh (str "delete " path))))))
